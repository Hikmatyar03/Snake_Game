<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake Game by Hikmtyar</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');

    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --accent-color: #FF4444;
      --background-dark: #1a1a1a;
      --text-light: #ffffff;
      --modal-bg: rgba(42, 42, 42, 0.95);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #1a1a1a;
      color: #fff;
    }
    h1 {
      margin-bottom: 20px;
      color: #4CAF50;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .game-container {
      display: grid;
      grid-template-columns: repeat(30, 20px);
      grid-template-rows: repeat(20, 20px);
      gap: 1px;
      background-color: #333;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .cell {
      width: 20px;
      height: 20px;
      background-color: #2a2a2a;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.1s;
    }
    .snake {
      background-color: #4CAF50;
      border-radius: 3px;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.8);
      border: 1px solid #45a049;
      animation: glow 0.5s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from {
        box-shadow: 0 0 5px rgba(76, 175, 80, 0.8);
        background-color: #4CAF50;
      }
      to {
        box-shadow: 0 0 10px rgba(76, 175, 80, 1);
        background-color: #45a049;
      }
    }
    .food {
      background-color: #FF4444;
      border-radius: 50%;
      box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
      animation: bounce 0.5s infinite alternate;
    }
    @keyframes bounce {
      from { transform: scale(1); }
      to { transform: scale(1.2); }
    }
    .wall {
      background-color: #666;
      border-radius: 2px;
    }
    .score {
      margin-top: 20px;
      font-size: 1.5em;
      background-color: #333;
      padding: 10px 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    .button {
      padding: 10px 20px;
      background-color: #4CAF50;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #45a049;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal {
      background: #2a2a2a;
      padding: 30px;
      border-radius: 10px;
      width: 80%;
      max-width: 500px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #333;
      color: white;
    }

    .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      font-size: 2em;
      text-align: center;
    }

    .difficulty-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .difficulty-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .difficulty-button.active {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .easy { background-color: #4CAF50; }
    .normal { background-color: #FFA500; }
    .hard { background-color: #FF4444; }

    .ai-snake {
      background-color: #FF8C00;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(255, 140, 0, 0.5);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .mode-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .mode-button {
      padding: 15px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
      font-weight: bold;
    }

    .mode-button.active {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .story { 
      background-color: #9C27B0; /* Purple */
    }
    .levels { 
      background-color: #2196F3; /* Blue */
    }
    .free { 
      background-color: #4CAF50; /* Green */
    }

    .difficulty-buttons {
      display: none;
    }

    .difficulty-buttons#difficultySection {
      display: flex;
    }

    .level-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 5px;
    }

    .story-dialog {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 5px;
      max-width: 80%;
      text-align: center;
    }

    .chapter-intro {
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border: 3px solid #9C27B0;
    }

    .reward-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 3px solid #FFD700;
      animation: scaleIn 0.5s;
    }

    .reward-animation {
      width: 100px;
      height: 100px;
      margin: 20px auto;
      background: url('trophy.png') no-repeat center;
      background-size: contain;
      animation: rotate 2s infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: translate(-50%, -50%) scale(0); }
      to { transform: translate(-50%, -50%) scale(1); }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .level-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 3px solid #2196F3;
      animation: scaleIn 0.5s;
      z-index: 1000;
      min-width: 300px;
    }

    .level-requirements {
      background: rgba(33, 150, 243, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }

    .level-complete {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 3px solid #4CAF50;
      animation: scaleIn 0.5s;
    }

    .level-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(33, 150, 243, 0.9);
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.2em;
      animation: slideIn 0.5s;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .game-message {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      animation: fadeInOut 3s;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }

    .cell {
      will-change: transform, background-color;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    .snake {
      transition: background-color 0.1s linear;
    }

    .game-container {
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }

    .ability-display {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 5px;
      color: white;
    }

    .story-mission {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 15px;
      border-radius: 10px;
      color: white;
      text-align: center;
      animation: fadeIn 0.5s;
    }

    .boss-warning {
      color: #ff4444;
      font-size: 1.2em;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .level-complete {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      border: 3px solid #4CAF50;
      animation: scaleIn 0.5s;
    }

    .level-target {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 5px;
      color: white;
    }

    @keyframes scaleIn {
      from { transform: translate(-50%, -50%) scale(0); }
      to { transform: translate(-50%, -50%) scale(1); }
    }

    .sound-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .sound-toggle:hover {
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.9);
    }

    .level-complete {
      animation: celebrateComplete 0.5s ease-out;
    }

    @keyframes celebrateComplete {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .game-wrapper {
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      box-sizing: border-box;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      margin-bottom: 20px;
      backdrop-filter: blur(5px);
    }

    .player-info {
      display: flex;
      gap: 20px;
      font-size: 1.2em;
    }

    .game-stats {
      display: flex;
      gap: 30px;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2em;
    }

    .game-modal {
      background: var(--modal-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      border: 2px solid var(--primary-color);
      animation: modalAppear 0.5s ease-out;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .modal-header h2 {
      font-family: 'Press Start 2P', cursive;
      color: var(--primary-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .form-group.animated {
      transform: translateY(20px);
      opacity: 0;
      animation: slideUp 0.5s forwards;
    }

    .custom-select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid var(--primary-color);
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .custom-select:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .mode-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
    }

    .mode-button {
      padding: 20px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .mode-button i {
      font-size: 24px;
    }

    .mode-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .start-button {
      width: 100%;
      padding: 15px;
      margin-top: 30px;
      border: none;
      border-radius: 8px;
      background: var(--primary-color);
      color: white;
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Press Start 2P', cursive;
    }

    .start-button:hover {
      background: #45a049;
      transform: scale(1.05);
    }

    @keyframes modalAppear {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Add animation delays for form groups */
    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }
    .form-group:nth-child(4) { animation-delay: 0.4s; }

    .game-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .game-container {
      margin: 20px 0;
      border: 3px solid var(--primary-color);
      border-radius: 15px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
    }

    /* Update existing button styles */
    .button {
      padding: 12px 25px;
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Press Start 2P', cursive;
      font-size: 0.8em;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Add difficulty section styles */
    #difficultySection {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
    }

    .difficulty-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .difficulty-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .game-ui {
      position: fixed;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .health-bars {
      position: absolute;
      top: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
    }

    .health-bar {
      width: 300px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
    }

    .health-label {
      color: white;
      margin-bottom: 5px;
      font-size: 14px;
      font-family: 'Press Start 2P', cursive;
    }

    .health-container {
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      position: relative;
      overflow: hidden;
    }

    .health-fill {
      height: 100%;
      width: 100%;
      transition: width 0.3s ease-in-out;
      position: absolute;
    }

    .player-health .health-fill {
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
    }

    .enemy-health .health-fill {
      background: linear-gradient(90deg, #f44336, #ff5722);
    }

    .health-text {
      position: absolute;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 20px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .power-up-display {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
    }

    .power-up-slot {
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .power-up-slot.active {
      border-color: #4CAF50;
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .status-effects {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 5px;
    }

    .status-effect {
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      animation: pulse 1s infinite;
    }

    .power-orb {
      border-radius: 50%;
      animation: float 2s infinite ease-in-out;
    }

    .power-orb.health { background: radial-gradient(#4CAF50, #2E7D32); }
    .power-orb.damage { background: radial-gradient(#f44336, #B71C1C); }
    .power-orb.speed { background: radial-gradient(#FFEB3B, #F57F17); }
    .power-orb.shield { background: radial-gradient(#2196F3, #1565C0); }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    /* Combat Effects */
    .snake.attacking {
      filter: brightness(1.5);
      animation: attack 0.3s ease-in-out;
    }

    .snake.damaged {
      animation: damage 0.3s ease-in-out;
    }

    .snake.shielded {
      box-shadow: 0 0 15px rgba(33, 150, 243, 0.8);
    }

    @keyframes attack {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes damage {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(2) saturate(2); }
    }

    /* Power-up Effects */
    .power-up-effect {
      position: absolute;
      pointer-events: none;
      animation: fadeOut 1s forwards;
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(-20px); }
    }

    /* Add enemies.css styles */
    .enemy {
        background-color: #ff4444;
        border-radius: 3px;
        box-shadow: 0 0 5px rgba(255, 68, 68, 0.8);
        animation: enemyPulse 1s infinite;
    }

    .boss-enemy {
        background-color: #c0392b;
        box-shadow: 0 0 10px rgba(192, 57, 43, 0.8);
        transform: scale(1.2);
    }

    .mission-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        padding: 30px;
        border-radius: 15px;
        color: white;
        max-width: 600px;
        text-align: left;
        z-index: 1000;
        border: 3px solid #4CAF50;
    }

    .mission-instructions ul {
        list-style-type: none;
        padding: 0;
    }

    .mission-instructions li {
        margin: 10px 0;
        padding-left: 20px;
        position: relative;
    }

    .mission-instructions li:before {
        content: '→';
        position: absolute;
        left: 0;
        color: #4CAF50;
    }

    .warning {
        background: rgba(255, 68, 68, 0.2);
        padding: 10px;
        border-radius: 5px;
        margin-top: 20px;
        text-align: center;
        color: #ff4444;
    }

    @keyframes enemyPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .level-complete, .game-complete {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        z-index: 1000;
        color: white;
        border: 3px solid #4CAF50;
        animation: fadeIn 0.5s ease-out;
    }

    .level-complete h2, .game-complete h2 {
        color: #4CAF50;
        margin-bottom: 20px;
    }

    .level-complete p, .game-complete p {
        margin: 10px 0;
        font-size: 1.2em;
    }

    .level-complete button, .game-complete button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 1.1em;
        background: #4CAF50;
        border: none;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .level-complete button:hover, .game-complete button:hover {
        background: #45a049;
        transform: scale(1.05);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -60%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <div class="game-header">
      <div class="player-info">
        <span class="player-name">Player: <span id="displayName"></span></span>
        <span class="player-level">Level: <span id="displayLevel">1</span></span>
      </div>
      <div class="game-stats">
        <div class="stat">
          <i class="fas fa-star"></i>
          <span id="score">0</span>
        </div>
        <div class="stat">
          <i class="fas fa-trophy"></i>
          <span id="highScore">0</span>
        </div>
      </div>
    </div>

    <div class="game-content">
      <h1>Snake Adventure</h1>
      <div class="game-container" id="game-container"></div>
      <div class="score">Score: <span id="score">0</span> | High Score: <span id="highScore">0</span></div>
      <div class="controls">
        <button class="button" onclick="resetGame()">New Game</button>
        <button class="button" onclick="togglePause()">Pause</button>
      </div>
    </div>

  <div id="welcomeModal" class="modal-overlay">
      <div class="modal game-modal">
        <div class="modal-header">
          <h2>🐍 Welcome to Snake Adventure! 🎮</h2>
        </div>
      <form id="playerForm" onsubmit="startGame(event)">
          <div class="form-group animated">
            <label>Name your Snake:</label>
            <input type="text" id="playerName" required placeholder="Enter your name...">
        </div>
          <div class="form-group animated">
            <label>Choose Your Identity:</label>
            <select id="playerGender" required class="custom-select">
              <option value="">Select Identity</option>
              <option value="male">Warrior</option>
              <option value="female">Huntress</option>
            <option value="tiktoker">TikToker</option>
          </select>
        </div>
          <div class="form-group animated">
            <label>What did He/She did :</label>
            <textarea id="playReason" required rows="3" placeholder="Why do you seek this adventure?"></textarea>
        </div>
          <div class="form-group animated">
            <label>Choose Your Path:</label>
          <div class="mode-buttons">
              <button type="button" class="mode-button story" onclick="selectMode('story')">
                <i class="fas fa-book"></i>
                Story Mode
              </button>
              <button type="button" class="mode-button levels" onclick="selectMode('levels')">
                <i class="fas fa-layer-group"></i>
                Level Mode
              </button>
              <button type="button" class="mode-button free" onclick="selectMode('free')">
                <i class="fas fa-infinity"></i>
                Free Mode
              </button>
          </div>
        </div>
        <div class="form-group" id="difficultySection" style="display: none;">
          <label>Select Difficulty:</label>
          <div class="difficulty-buttons">
            <button type="button" class="difficulty-button easy" onclick="selectDifficulty('easy')">Easy</button>
            <button type="button" class="difficulty-button normal" onclick="selectDifficulty('normal')">Normal</button>
            <button type="button" class="difficulty-button hard" onclick="selectDifficulty('hard')">Hard</button>
          </div>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enableAISnakes" checked>
            Enable AI Snakes
          </label>
        </div>
          <button type="submit" class="start-button">Begin Adventure!</button>
      </form>
      </div>
    </div>
  </div>

  <div id="gameOverScreen" class="game-over-screen">
    <div>
      <h2>Samp Ne Das Leya</h2>
      <p>Score: <span id="finalScore">0</span></p>
      <button class="button" onclick="hideGameOver()">Play Again</button>
    </div>
  </div>

  <div class="game-ui">
    <!-- Health Bars -->
    <div class="health-bars">
      <div class="health-bar player-health">
        <div class="health-label">Your Health</div>
        <div class="health-container">
          <div class="health-fill" id="playerHealthFill"></div>
          <span class="health-text" id="playerHealthText">100/100</span>
        </div>
      </div>
      <div class="health-bar enemy-health">
        <div class="health-label">Enemy Health</div>
        <div class="health-container">
          <div class="health-fill" id="enemyHealthFill"></div>
          <span class="health-text" id="enemyHealthText">50/50</span>
        </div>
      </div>
    </div>

    <!-- Power-up Display -->
    <div class="power-up-display">
      <div class="power-up-slot" id="powerSlot1"></div>
      <div class="power-up-slot" id="powerSlot2"></div>
      <div class="power-up-slot" id="powerSlot3"></div>
    </div>

    <!-- Status Effects -->
    <div class="status-effects" id="statusEffects"></div>
  </div>

  <script>
    const WIDTH = 30;
    const HEIGHT = 20;
    const BASE_SPEED = 200; // Base speed in milliseconds
    let grid = [];
    let snake = [{ x: 0, y: 0 }];
    let food = null;
    let direction = 'RIGHT';
    let score = 0;
    let gameInterval;
    let isPaused = false;
    let highScore = 0;
    let isGameOver = false;
    let selectedDifficulty = '';
    let playerData = {};
    let aiSnakes = [];
    const AI_SNAKE_COUNT = 3;
    let gameMode = '';
    let currentLevel = 1;
    let storyProgress = 0;
    const STORY_MISSIONS = [
        { text: "Welcome young snake! Complete your first mission: Eat 5 food items", target: 5 },
        { text: "Great! Now try to eat 2 AI snakes", target: 2 },
        { text: "Final test: Reach length 15 without dying", target: 15 }
    ];

    const LEVELS = [
        {
            title: "Level 1: First Steps",
            intro: "Welcome! Collect food to grow longer.",
            target: 5,
            speed: BASE_SPEED
        },
        {
            title: "Level 2: Getting Tougher",
            intro: "Watch out for walls!",
            target: 8,
            speed: BASE_SPEED - 20
        },
        {
            title: "Level 3: Final Challenge",
            intro: "Can you reach the target?",
            target: 10,
            speed: BASE_SPEED - 30
        }
    ];

    // Enhanced story chapters with more engaging narrative
    const STORY_CHAPTERS = [
        {
            title: "Chapter 1: The Beginning",
            intro: "Your journey begins as a young snake in the digital world...",
            missions: [
                {
                    text: "Collect 5 food items to grow stronger",
                    target: 5,
                    type: 'food'
                },
                {
                    text: "Reach length 8 without hitting walls",
                    target: 8,
                    type: 'length'
                }
            ]
        }
    ];

    let currentChapter = 0;
    let currentMission = 0;
    let missionTimer = 0;
    let specialAbilities = {
        ghostMode: false,
        shield: false,
        timeSlow: false,
        multiCore: false,
        ultimateForm: false,
        ghostModeCharges: 1,
        shieldCharges: 2,
        timeSlowCharges: 3
    };

    // Add these variables
    let gameStarted = false;
    let waitingForStart = true;

    // Show welcome modal on load
    window.onload = function() {
      document.getElementById('welcomeModal').style.display = 'flex';
    };

    function selectDifficulty(difficulty) {
      selectedDifficulty = difficulty;
      document.querySelectorAll('.difficulty-button').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.difficulty-button.${difficulty}`).classList.add('active');
    }

    function selectMode(mode) {
        gameMode = mode;
        document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.mode-button.${mode}`).classList.add('active');
        
        // Show/hide difficulty section based on mode
        document.getElementById('difficultySection').style.display = 
            mode === 'free' ? 'block' : 'none';
    }

    // Add this function to handle the TikToker selection
    function checkTikToker() {
        const genderSelect = document.getElementById('playerGender');
        if (genderSelect.value === 'tiktoker') {
            const gaySound = new Audio('gay.mp3');
            gaySound.play()
                .catch(error => console.log("Audio playback failed:", error));
            alert("Congratulations! You've chosen to be a TikToker! 🎵");
        }
    }

    // Update the startGame function
    function startGame(event) {
        event.preventDefault();
        if (!gameMode) {
            alert('Please select a game mode!');
            return;
        }

        // Check for TikToker selection
        if (document.getElementById('playerGender').value === 'tiktoker') {
            const gaySound = new Audio('gay.mp3');
            gaySound.play().catch(err => console.log('Sound play failed:', err));
            alert("Congratulations! You've chosen to be a TikToker! 🎵");
        }

        playerData = {
            name: document.getElementById('playerName').value,
            gender: document.getElementById('playerGender').value,
            mode: gameMode,
            difficulty: selectedDifficulty
        };

        document.getElementById('displayName').textContent = playerData.name;
        document.getElementById('welcomeModal').style.display = 'none';
        
        initializeLevelMode();
    }

    // Initialize the grid
    function initializeGrid() {
      const container = document.getElementById('game-container');
      container.innerHTML = '';
      grid = [];
      
      const fragment = document.createDocumentFragment();
      
      for (let y = 0; y < HEIGHT; y++) {
        let row = [];
        for (let x = 0; x < WIDTH; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          fragment.appendChild(cell);
          row.push(cell);
        }
        grid.push(row);
      }
      
      container.appendChild(fragment);
      
      // Initialize snake
      snake = [{ x: 1, y: 1 }];
      grid[1][1].classList.add('snake');
      waitingForStart = true;
      gameStarted = false;
    }

    // Generate maze walls
    function generateMaze() {
        // Clear existing walls
        grid.forEach(row => row.forEach(cell => {
            if (cell.classList.contains('wall')) {
                cell.classList.remove('wall');
            }
        }));

        const levelData = LEVELS[currentLevel - 1];
        const wallDensity = levelData.walls;

        // Keep track of empty spaces to ensure playability
        let emptySpaces = [];
        
        for (let y = 0; y < HEIGHT; y++) {
            for (let x = 0; x < WIDTH; x++) {
                // Don't place walls near the snake start position
                if (x < 3 && y < 3) continue;
                
                // Don't place walls near the edges
                if (x === 0 || x === WIDTH-1 || y === 0 || y === HEIGHT-1) continue;

                if (Math.random() < wallDensity) {
                    // Check surrounding cells to avoid creating tight spaces
                    let surroundingWalls = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (y+dy >= 0 && y+dy < HEIGHT && x+dx >= 0 && x+dx < WIDTH) {
                                if (grid[y+dy][x+dx].classList.contains('wall')) {
                                    surroundingWalls++;
                                }
                            }
                        }
                    }
                    
                    // Only place wall if there aren't too many surrounding walls
                    if (surroundingWalls < 2) {
                        grid[y][x].classList.add('wall');
                    }
                } else {
                    emptySpaces.push({x, y});
                }
            }
        }

        // Ensure there's always a path to food
        if (emptySpaces.length < levelData.target * 2) {
            // If not enough empty spaces, remove some walls
            grid.forEach(row => row.forEach(cell => {
                if (cell.classList.contains('wall') && Math.random() < 0.5) {
                    cell.classList.remove('wall');
                }
            }));
        }
    }

    // Place food randomly
    function placeFood() {
      // Remove existing food if any
      if (food) {
        grid[food.y][food.x].classList.remove('food');
      }
      
      let x, y;
      let attempts = 0;
      const maxAttempts = WIDTH * HEIGHT;
      
      do {
        x = Math.floor(Math.random() * WIDTH);
        y = Math.floor(Math.random() * HEIGHT);
        attempts++;
        if (attempts > maxAttempts) {
          // No valid position found
          return false;
        }
      } while (
        grid[y][x].classList.contains('wall') || 
        grid[y][x].classList.contains('snake')
      );
      
      food = { x, y };
      grid[y][x].classList.add('food');
      return true;
    }

    class AISnake {
      constructor(x, y) {
        this.body = [
          { x, y },
          { x: x-1, y },
          { x: x-2, y }
        ]; // Start with length of 3
        this.direction = ['UP', 'DOWN', 'LEFT', 'RIGHT'][Math.floor(Math.random() * 4)];
        // Initialize the snake's appearance
        this.body.forEach(segment => {
          if (grid[segment.y] && grid[segment.y][segment.x]) {
            grid[segment.y][segment.x].classList.add('ai-snake');
          }
        });
      }

      move() {
        const head = { ...this.body[0] };
        const possibleDirections = ['UP', 'DOWN', 'LEFT', 'RIGHT'];
        
        // Randomly change direction sometimes
        if (Math.random() < 0.1) {
          this.direction = possibleDirections[Math.floor(Math.random() * 4)];
        }

        // Move based on current direction
        switch (this.direction) {
          case 'UP': head.y--; break;
          case 'DOWN': head.y++; break;
          case 'LEFT': head.x--; break;
          case 'RIGHT': head.x++; break;
        }

        // Wrap around the edges
        if (head.x < 0) head.x = WIDTH - 1;
        if (head.x >= WIDTH) head.x = 0;
        if (head.y < 0) head.y = HEIGHT - 1;
        if (head.y >= HEIGHT) head.y = 0;

        // Check for wall collision and change direction if needed
        if (grid[head.y][head.x].classList.contains('wall')) {
          return false;
        }

        // Remove old position
        const tail = this.body.pop();
        if (tail) {
          grid[tail.y][tail.x].classList.remove('ai-snake');
        }

        // Add new position
        this.body.unshift(head);
        grid[head.y][head.x].classList.add('ai-snake');
        return true;
      }
    }

    function initializeAISnakes() {
      aiSnakes = [];
      // Only initialize AI snakes if enabled
      if (!playerData.enableAISnakes) return;

      for (let i = 0; i < AI_SNAKE_COUNT; i++) {
        let x, y;
        do {
          x = Math.floor(Math.random() * (WIDTH - 3)); // -3 to ensure space for initial body
          y = Math.floor(Math.random() * HEIGHT);
        } while (
          grid[y][x].classList.contains('wall') ||
          grid[y][x].classList.contains('snake') ||
          grid[y][x].classList.contains('ai-snake') ||
          !isSpaceClear(x, y)
        );
        aiSnakes.push(new AISnake(x, y));
      }
    }

    function isSpaceClear(x, y) {
      // Check if there's enough space for the initial snake body
      for (let i = 0; i < 3; i++) {
        if (x - i < 0 || 
          grid[y][x-i].classList.contains('wall') ||
          grid[y][x-i].classList.contains('snake') ||
          grid[y][x-i].classList.contains('ai-snake')) {
          return false;
        }
      }
      return true;
    }

    // Update the game state
    function update() {
        if (isPaused || isGameOver || waitingForStart || !gameStarted) return;
        
        const head = { ...snake[0] };
        
        // Calculate new head position
        switch (direction) {
            case 'UP': head.y = (head.y - 1 + HEIGHT) % HEIGHT; break;
            case 'DOWN': head.y = (head.y + 1) % HEIGHT; break;
            case 'LEFT': head.x = (head.x - 1 + WIDTH) % WIDTH; break;
            case 'RIGHT': head.x = (head.x + 1) % WIDTH; break;
        }

        // Check for collisions
        if (checkCollision(head)) {
            gameOver();
            return;
        }

        // Update snake position
        snake.unshift(head);
        grid[head.y][head.x].classList.add('snake');

        // Check for food
        if (head.x === food.x && head.y === food.y) {
            // Play eat sound
            if (isSoundEnabled) {
                sounds.eat.play().catch(err => console.log('Sound play failed:', err));
            }
            
            score++;
            document.getElementById('score').textContent = score;
            placeFood();
            if (gameMode === 'levels') {
            checkLevelCompletion();
            }
        } else {
            const tail = snake.pop();
            if (tail) {
                grid[tail.y][tail.x].classList.remove('snake');
            }
        }

        // Update enemies
        if (playerData.enableAISnakes) {
            requestAnimationFrame(() => {
                aiSnakes.forEach(aiSnake => aiSnake.move());
            });
        }
    }

    // Optimize interval management
    function startGameInterval(speed) {
        if (gameInterval) {
            clearInterval(gameInterval);
        }
        gameInterval = setInterval(() => {
            requestAnimationFrame(update);
        }, speed);
    }

    function updateStoryMode() {
        const chapter = STORY_CHAPTERS[currentChapter];
        const mission = chapter.missions[currentMission];
        
        if (!mission) return;

        let completed = false;
        switch(mission.type) {
            case 'food':
                completed = score >= mission.target;
                break;
            case 'length':
                completed = snake.length >= mission.target;
                break;
        }

        if (completed) {
            currentMission++;
            if (currentMission >= chapter.missions.length) {
                currentChapter++;
                currentMission = 0;
                if (currentChapter < STORY_CHAPTERS.length) {
                        showStoryDialog(STORY_CHAPTERS[currentChapter].intro, true);
                } else {
                    showStoryDialog("Congratulations! You've completed the story!", true);
                }
            } else {
                showStoryDialog(chapter.missions[currentMission].text);
            }
        }
    }

    function updateLevelMode() {
        const levelData = LEVELS[currentLevel - 1];
        if (score >= levelData.target) {
            showLevelComplete();
        }
    }

    // Reset the game
    function resetGame() {
      // Clear any existing game interval
      if (gameInterval) {
        clearInterval(gameInterval);
      }

      isGameOver = false;
      isPaused = false;
      snake = [{ x: 1, y: 1 }]; // Start slightly away from edge
      direction = 'RIGHT';
      score = 0;
      document.getElementById('score').textContent = score;
      
      // Clear the grid
      grid.forEach(row => row.forEach(cell => {
        cell.className = 'cell';
      }));
      
      // Make initial snake visible
      grid[1][1].classList.add('snake');
      
      // Regenerate maze and place food
      generateMaze();
      initializeAISnakes();
      placeFood();
      
      // Restart game interval
      startGameInterval(LEVELS[currentLevel - 1].speed);
    }

    // Optimize event listener
    let lastKeyTime = 0;
    const KEY_DELAY = 50; // Minimum delay between key presses in milliseconds

    document.addEventListener('keydown', (e) => {
        const now = Date.now();
        if (now - lastKeyTime < KEY_DELAY) return;
        lastKeyTime = now;

        if (!gameStarted && (
            e.key === 'ArrowUp' || 
            e.key === 'ArrowDown' || 
            e.key === 'ArrowLeft' || 
            e.key === 'ArrowRight'
        )) {
            gameStarted = true;
            waitingForStart = false;
            switch (e.key) {
                case 'ArrowUp': direction = 'UP'; break;
                case 'ArrowDown': direction = 'DOWN'; break;
                case 'ArrowLeft': direction = 'LEFT'; break;
                case 'ArrowRight': direction = 'RIGHT'; break;
            }
            return;
        }

        if (gameStarted) {
            switch (e.key) {
                case 'ArrowUp': if (direction !== 'DOWN') direction = 'UP'; break;
                case 'ArrowDown': if (direction !== 'UP') direction = 'DOWN'; break;
                case 'ArrowLeft': if (direction !== 'RIGHT') direction = 'LEFT'; break;
                case 'ArrowRight': if (direction !== 'LEFT') direction = 'RIGHT'; break;
            }
        }

        if (e.key === ' ' || e.key === 'p') {
            togglePause();
        }
    });

    function togglePause() {
      if (!isGameOver) {
        isPaused = !isPaused;
        if (isPaused) {
          clearInterval(gameInterval);
        } else {
          const levelData = LEVELS[currentLevel - 1];
          startGameInterval(levelData.speed);
        }
      }
    }

    function showGameOver() {
      document.getElementById('finalScore').textContent = score;
      document.getElementById('gameOverScreen').style.display = 'flex';
    }

    function hideGameOver() {
      document.getElementById('gameOverScreen').style.display = 'none';
      resetGame();
    }

    function initializeGame() {
      // Clear any existing elements
      if (gameInterval) clearInterval(gameInterval);
      grid = [];
      
      // Initialize grid
      initializeGrid();
      
      // Generate maze based on game mode
      generateMaze();
      
      // Initialize AI snakes if enabled
      if (playerData.enableAISnakes) {
      initializeAISnakes();
      }
      
      // Place initial food
      placeFood();
      
      // Set initial game state
      score = 0;
      document.getElementById('score').textContent = '0';
      isGameOver = false;
      isPaused = false;
      waitingForStart = true;
      gameStarted = false;
      
      // Start game interval based on mode/level
      const speed = gameMode === 'free' ? 
          BASE_SPEED - (selectedDifficulty === 'hard' ? 50 : selectedDifficulty === 'normal' ? 25 : 0) :
          LEVELS[currentLevel - 1].speed;
      
      startGameInterval(speed);
      
      // Show appropriate UI elements based on game mode
      if (gameMode === 'levels') {
          showLevelTarget();
      }
      
      showMissionBriefing(currentLevel);
      updateHealthBars();
    }

    function initializeStoryMode() {
        storyProgress = 0;
        currentChapter = 0;
        currentMission = 0;
        missionTimer = 0;
        
        // Reset abilities
        specialAbilities = {
            ghostMode: false,
            shield: false,
            timeSlow: false,
            multiCore: false,
            ultimateForm: false,
            ghostModeCharges: 1,
            shieldCharges: 2,
            timeSlowCharges: 3
        };

        // Show chapter intro
        showStoryDialog(STORY_CHAPTERS[currentChapter].intro, true);
        
        // Apply story mode settings
        selectedDifficulty = 'easy';
        updateGameSpeed();
        applySpecialAbilities();
    }

    function initializeLevelMode() {
        isGameOver = false;
        isPaused = false;
        score = 0;
        currentLevel = 1;
        snake = [{ x: 1, y: 1 }];
        direction = 'RIGHT';
        
        initializeGrid();
        placeFood();
        
        document.getElementById('score').textContent = '0';
        document.getElementById('displayLevel').textContent = currentLevel;
        
        showLevelIntro();
    }

    function initializeFreeMode() {
        // Use selected difficulty settings
    }

    function showStoryDialog(text, isIntro = false) {
        const dialog = document.createElement('div');
        dialog.className = 'story-dialog';
        if (isIntro) {
            dialog.classList.add('chapter-intro');
        }
        dialog.innerHTML = `
            <h3>${STORY_CHAPTERS[currentChapter].title}</h3>
            <p>${text}</p>
            ${isIntro ? '<button onclick="this.parentElement.remove()" class="button">Begin Mission</button>' : ''}
        `;
        document.body.appendChild(dialog);
        if (!isIntro) {
            setTimeout(() => dialog.remove(), 5000);
        }
    }

    function showLevelIntro() {
        const level = LEVELS[currentLevel - 1];
        const dialog = document.createElement('div');
        dialog.className = 'level-dialog';
        dialog.innerHTML = `
            <h2>${level.title}</h2>
            <p>${level.intro}</p>
            <div class="level-requirements">
                <p>Target Score: ${level.target}</p>
                <p>Use arrow keys to move</p>
                <p>Collect food to score points</p>
            </div>
            <button onclick="startLevel()" class="button">Start Level</button>
        `;
        document.body.appendChild(dialog);
    }

    function startLevel() {
        // Remove any dialogs
        const dialogs = document.querySelectorAll('.level-dialog, .mission-overlay');
        dialogs.forEach(dialog => dialog.remove());
        
        // Reset start state
        waitingForStart = true;
        gameStarted = false;
        isPaused = false;
        
        // Make sure snake is visible
        grid[1][1].classList.add('snake');
        
        // Start game interval
        const levelData = LEVELS[currentLevel - 1];
        startGameInterval(levelData.speed);

        // Show start instruction
        showMessage("Press any arrow key to start moving!");
    }

    function getDifficultyRating(level) {
        const stars = '⭐'.repeat(Math.ceil(level / 2));
        return stars;
    }

    function applyLevelSettings(levelData) {
        if (gameInterval) {
            clearInterval(gameInterval);
        }
        
        // Apply the level-specific settings
        wallDensity = levelData.walls;
        AI_SNAKE_COUNT = levelData.aiSnakes;
        
        // Start game interval with level-specific speed
        startGameInterval(levelData.speed);
        
        // Initialize power-ups if enabled
        if (levelData.powerUps) {
            initializePowerUps();
        }
    }

    function gameOver() {
      isGameOver = true;
        gameStarted = false; // Add this to prevent movement
        clearInterval(gameInterval);
        
        // Play death sound
        if (isSoundEnabled) {
            sounds.die.play().catch(err => console.log('Sound play failed:', err));
        }
        
      if (score > highScore) {
        highScore = score;
        document.getElementById('highScore').textContent = highScore;
      }
      showGameOver();
    }

    function showReward(reward) {
        const rewardDialog = document.createElement('div');
        rewardDialog.className = 'reward-dialog';
        rewardDialog.innerHTML = `
            <h3>🏆 Reward Unlocked! 🏆</h3>
            <p>${reward}</p>
            <div class="reward-animation"></div>
            <button onclick="this.parentElement.remove()" class="button">Continue</button>
        `;
        document.body.appendChild(rewardDialog);
    }

    function applyReward(chapter, mission) {
        switch(chapter) {
            case 0:
                if (mission === 0) specialAbilities.ghostMode = true;
                if (mission === 1) specialAbilities.shield = true;
                break;
            case 1:
                if (mission === 0) specialAbilities.timeSlow = true;
                break;
            case 2:
                if (mission === 0) specialAbilities.multiCore = true;
                break;
            case 3:
                if (mission === 0) specialAbilities.ultimateForm = true;
                break;
        }
        applySpecialAbilities();
    }

    function applySpecialAbilities() {
        // Apply speed boost
        if (specialAbilities.ghostMode) {
            showMessage("Ghost Mode Activated!");
            const snakeElements = document.querySelectorAll('.snake');
            snakeElements.forEach(el => el.style.opacity = '0.5');
            setTimeout(() => {
                snakeElements.forEach(el => el.style.opacity = '1');
            }, 3000);
            updateAbilityDisplay();
        }

        // Apply shield
        if (specialAbilities.shield) {
            showMessage("Shield Activated!");
            const snakeElements = document.querySelectorAll('.snake');
            snakeElements.forEach(el => el.style.boxShadow = '0 0 10px #00f');
            setTimeout(() => {
                snakeElements.forEach(el => el.style.boxShadow = '');
            }, 5000);
            updateAbilityDisplay();
        }

        // Apply time slow
        if (specialAbilities.timeSlow) {
            showMessage("Time Slow Activated!");
            const originalSpeed = gameInterval;
            startGameInterval(currentSpeed * 1.5);
            setTimeout(() => {
                startGameInterval(currentSpeed);
            }, 4000);
            updateAbilityDisplay();
        }

        // Apply multi-core processing
        if (specialAbilities.multiCore) {
            // Implement multi-core processing logic
        }

        // Apply ultimate form
        if (specialAbilities.ultimateForm) {
            // Implement ultimate form logic
        }
    }

    function updateGameSpeed() {
        // Implement game speed update logic based on special abilities
    }

    // Update the showLevelComplete function
    function showLevelComplete() {
        clearInterval(gameInterval); // Stop the game
        isPaused = true;
        gameStarted = false;
        
        // Play level complete sound
        const levelCompleteSound = new Audio('level-complete.mp3');
        levelCompleteSound.play()
            .catch(error => console.log("Audio playback failed:", error));
        
        const dialog = document.createElement('div');
        dialog.className = 'level-complete';
        dialog.innerHTML = `
            <h2>Level ${currentLevel} Complete! 🎉</h2>
            <p>Score: ${score}</p>
            ${currentLevel < LEVELS.length ? 
                '<button onclick="nextLevel()" class="button">Next Level</button>' :
                '<button onclick="completeLevelMode()" class="button">Complete Game!</button>'}
        `;
        document.body.appendChild(dialog);
    }

    function checkLevelCompletion() {
        const levelData = LEVELS[currentLevel - 1];
        if (score >= levelData.target) {
            clearInterval(gameInterval); // Stop the game
            isPaused = true;
            showLevelComplete();
        }
    }

    function nextLevel() {
        currentLevel++;
        if (currentLevel <= LEVELS.length) {
            score = 0;
            snake = [{ x: 1, y: 1 }];
            direction = 'RIGHT';
            
            initializeGrid();
            placeFood();
            
            document.getElementById('score').textContent = '0';
            document.getElementById('displayLevel').textContent = currentLevel;
            
            showLevelIntro();
        } else {
            completeLevelMode();
        }
    }

    function completeLevelMode() {
        clearInterval(gameInterval); // Stop the game
        isGameOver = true;
        gameStarted = false; // Add this to prevent movement
        
        // Play game complete sound
        if (isSoundEnabled) {
            sounds.gameComplete.play().catch(err => console.log('Sound play failed:', err));
        }
        
        const dialog = document.createElement('div');
        dialog.className = 'game-complete';
        dialog.innerHTML = `
            <h2>🎉 Congratulations! 🎉</h2>
            <p>You've completed all levels!</p>
            <p>Final Score: ${score}</p>
            <button onclick="resetToMainMenu()" class="button">Back to Menu</button>
        `;
        document.body.appendChild(dialog);
    }

    function getElapsedTime() {
        // Implement time tracking logic
        return '00:00';
    }

    function initializePowerUps() {
        // Implement power-ups logic
    }

    function removeGameModeUI() {
        const elements = document.querySelectorAll('.story-dialog, .level-indicator');
        elements.forEach(el => el.remove());
    }

    // Add this function to handle returning to main menu
    function resetToMainMenu() {
        location.reload(); // Reload the page to restart completely
    }

    function showMessage(text) {
        const message = document.createElement('div');
        message.className = 'game-message';
        message.textContent = text;
        document.body.appendChild(message);
        setTimeout(() => message.remove(), 3000);
    }

    // Add these functions for special abilities
    function handleSpecialAbilities(e) {
        if (!gameStarted || isPaused || isGameOver) return;

        switch(e.key.toLowerCase()) {
            case 'g':
                if (specialAbilities.ghostMode && specialAbilities.ghostModeCharges > 0) {
                    activateGhostMode();
                }
                break;
            case 's':
                if (specialAbilities.shield && specialAbilities.shieldCharges > 0) {
                    activateShield();
                }
                break;
            case 't':
                if (specialAbilities.timeSlow && specialAbilities.timeSlowCharges > 0) {
                    activateTimeSlow();
                }
                break;
        }
    }

    // Add event listener for special abilities
    document.addEventListener('keydown', handleSpecialAbilities);

    function activateGhostMode() {
        specialAbilities.ghostModeCharges--;
        showMessage("Ghost Mode Activated!");
        const snakeElements = document.querySelectorAll('.snake');
        snakeElements.forEach(el => el.style.opacity = '0.5');
        setTimeout(() => {
            snakeElements.forEach(el => el.style.opacity = '1');
        }, 3000);
        updateAbilityDisplay();
    }

    function activateShield() {
        specialAbilities.shieldCharges--;
        showMessage("Shield Activated!");
        const snakeElements = document.querySelectorAll('.snake');
        snakeElements.forEach(el => el.style.boxShadow = '0 0 10px #00f');
        setTimeout(() => {
            snakeElements.forEach(el => el.style.boxShadow = '');
        }, 5000);
        updateAbilityDisplay();
    }

    function activateTimeSlow() {
        specialAbilities.timeSlowCharges--;
        showMessage("Time Slow Activated!");
        const originalSpeed = gameInterval;
        startGameInterval(currentSpeed * 1.5);
        setTimeout(() => {
            startGameInterval(currentSpeed);
        }, 4000);
        updateAbilityDisplay();
    }

    function updateAbilityDisplay() {
        const abilityDisplay = document.getElementById('abilityDisplay');
        abilityDisplay.innerHTML = `
            ${specialAbilities.ghostMode ? `Ghost Mode (${specialAbilities.ghostModeCharges}) | ` : ''}
            ${specialAbilities.shield ? `Shield (${specialAbilities.shieldCharges}) | ` : ''}
            ${specialAbilities.timeSlow ? `Time Slow (${specialAbilities.timeSlowCharges})` : ''}
        `;
    }

    // Add this HTML element for ability display
    const abilityDisplayHTML = `
        <div id="abilityDisplay" class="ability-display"></div>
    `;

    // Add target score display
    function showLevelTarget() {
        const targetDisplay = document.createElement('div');
        targetDisplay.className = 'level-target';
        targetDisplay.textContent = `Target Score: ${LEVELS[currentLevel - 1].target}`;
        document.body.appendChild(targetDisplay);
    }

    // Update the audio elements to use your local file
    const audioElements = `
        <audio id="levelCompleteSound" preload="auto">
            <source src="level-complete.mp3" type="audio/mpeg">
        </audio>
        <audio id="gameCompleteSound" preload="auto">
            <source src="level-complete.mp3" type="audio/mpeg">
        </audio>
    `;
    document.body.insertAdjacentHTML('beforeend', audioElements);

    // Update the play functions to handle the audio better
    function playLevelCompleteSound() {
        const sound = document.getElementById('levelCompleteSound');
        if (sound && isSoundEnabled) {
            sound.currentTime = 0; // Reset sound to start
            sound.volume = 0.5;    // Set volume to 50%
            sound.play()
                .catch(error => console.log("Audio playback failed:", error));
        }
    }

    function playGameCompleteSound() {
        const sound = document.getElementById('gameCompleteSound');
        if (sound && isSoundEnabled) {
            sound.currentTime = 0;
            sound.volume = 0.5;
            sound.play()
                .catch(error => console.log("Audio playback failed:", error));
        }
    }

    // Add audio control functions
    let isSoundEnabled = true;

    function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        const sounds = document.querySelectorAll('audio');
        sounds.forEach(sound => {
            sound.muted = !isSoundEnabled;
        });
        updateSoundButton();
    }

    function updateSoundButton() {
        const soundButton = document.querySelector('.sound-toggle');
        if (soundButton) {
            soundButton.innerHTML = isSoundEnabled ? '🔊' : '🔇';
        }
    }

    // Add sound toggle button
    const soundButton = `
        <button class="sound-toggle" onclick="toggleSound()">🔊</button>
    `;
    document.body.insertAdjacentHTML('beforeend', soundButton);

    // Add debug function to check snake visibility
    function debugSnakePosition() {
        console.log('Snake positions:', snake);
        console.log('Snake head cell classes:', grid[snake[0].y][snake[0].x].className);
    }

    // Initialize health and power-up system
    let playerHealth = 100;
    let maxPlayerHealth = 100;
    let enemyHealth = 50;
    let maxEnemyHealth = 50;
    let activePowerUps = [];

    function updateHealthBars() {
      // Update player health
      const playerFill = document.getElementById('playerHealthFill');
      const playerText = document.getElementById('playerHealthText');
      const playerPercentage = (playerHealth / maxPlayerHealth) * 100;
      playerFill.style.width = `${playerPercentage}%`;
      playerText.textContent = `${playerHealth}/${maxPlayerHealth}`;

      // Update enemy health
      const enemyFill = document.getElementById('enemyHealthFill');
      const enemyText = document.getElementById('enemyHealthText');
      const enemyPercentage = (enemyHealth / maxEnemyHealth) * 100;
      enemyFill.style.width = `${enemyPercentage}%`;
      enemyText.textContent = `${enemyHealth}/${maxEnemyHealth}`;
    }

    function addPowerUp(type) {
      const slot = document.querySelector('.power-up-slot:not(.active)');
      if (slot) {
        slot.classList.add('active');
        slot.setAttribute('data-power', type);
        slot.style.backgroundImage = `url('assets/powers/${type}.png')`;
        activePowerUps.push(type);
      }
    }

    function showDamageEffect(x, y, amount) {
      const effect = document.createElement('div');
      effect.className = 'power-up-effect';
      effect.textContent = `-${amount}`;
      effect.style.left = `${x}px`;
      effect.style.top = `${y}px`;
      document.body.appendChild(effect);
      setTimeout(() => effect.remove(), 1000);
    }

    // Update the collision detection to include combat
    function handleCollision(snake1, snake2) {
      if (snake1.isPlayer) {
        // Player attacking enemy
        enemyHealth -= combatMechanics.collision.damage;
        showDamageEffect(snake2.x, snake2.y, combatMechanics.collision.damage);
      } else {
        // Enemy attacking player
        playerHealth -= combatMechanics.collision.damage;
        showDamageEffect(snake1.x, snake1.y, combatMechanics.collision.damage);
      }
      updateHealthBars();
    }

    // Add this after your existing variable declarations
    const ENEMY_TYPES = {
        basic: {
            health: 50,
            damage: 10,
            speed: 0.3,
            color: '#ff4444',
            points: 100
        },
        poison: {
            health: 75,
            damage: 15,
            speed: 0.4,
            color: '#8e44ad',
            points: 150
        },
        boss: {
            health: 500,
            damage: 25,
            speed: 0.2,
            color: '#c0392b',
            points: 1000
        }
    };

    // Add this function to spawn enemies
    function spawnEnemies(level) {
        enemies = []; // Clear existing enemies
        
        if (level === LEVELS.length) { // Boss level
            const boss = new Enemy('boss', 
                Math.floor(WIDTH / 2), 
                Math.floor(HEIGHT / 2),
                ENEMY_TYPES.boss.health,
                ENEMY_TYPES.boss.damage,
                ENEMY_TYPES.boss.speed
            );
            enemies.push(boss);
            showMessage("⚠️ BOSS BATTLE! ⚠️");
        } else {
            // Regular levels
            const enemyCount = Math.min(level + 1, 5); // Increase enemies per level
            for (let i = 0; i < enemyCount; i++) {
                const type = Math.random() > 0.7 ? 'poison' : 'basic';
                const enemy = new Enemy(
                    type,
                    Math.floor(Math.random() * WIDTH),
                    Math.floor(Math.random() * HEIGHT),
                    ENEMY_TYPES[type].health,
                    ENEMY_TYPES[type].damage,
                    ENEMY_TYPES[type].speed
                );
                enemies.push(enemy);
            }
        }
    }

    // Add this function to show mission briefing
    function showMissionBriefing(level) {
        const overlay = document.createElement('div');
        overlay.className = 'mission-overlay';
        
        let missionText = '';
        if (level === LEVELS.length) {
            missionText = `
                <h2>🔥 FINAL BOSS BATTLE 🔥</h2>
                <p>The mighty boss snake has appeared!</p>
                <ul>
                    <li>Boss Health: 500</li>
                    <li>Boss Damage: 25</li>
                    <li>Collect health orbs to survive</li>
                    <li>Use power-ups strategically</li>
                </ul>
                <div class="warning">This is your final test. Good luck!</div>
            `;
        } else {
            missionText = `
                <h2>Level ${level} Mission</h2>
                <p>${LEVELS[level-1].intro}</p>
                <ul>
                    <li>Defeat ${Math.min(level + 1, 5)} enemy snakes</li>
                    <li>Collect food for health (+10 HP)</li>
                    <li>Avoid enemy attacks (${ENEMY_TYPES.basic.damage}-${ENEMY_TYPES.poison.damage} damage)</li>
                    <li>Target Score: ${LEVELS[level-1].target}</li>
                </ul>
                <div class="tip">Tip: Ram into enemies to deal damage!</div>
            `;
        }
        
        overlay.innerHTML = `
            ${missionText}
            <button class="start-mission-btn">Begin Mission</button>
        `;
        
        document.body.appendChild(overlay);
        
        overlay.querySelector('.start-mission-btn').onclick = () => {
            overlay.remove();
            isPaused = false;
            gameStarted = true;
            spawnEnemies(level);
        };
    }

    // Add this function to place health orbs
    function placeHealthOrb(x, y) {
        const cell = grid[y][x];
        cell.className = 'cell health-orb';
        setTimeout(() => {
            if (cell.classList.contains('health-orb')) {
                cell.className = 'cell';
            }
        }, 5000); // Disappear after 5 seconds
    }

    function checkCollision(head) {
        // Check wall collision
        if (grid[head.y][head.x].classList.contains('wall')) {
            return true;
        }
        
        // Check self collision
        return snake.some((segment, index) => {
            return index !== 0 && segment.x === head.x && segment.y === head.y;
        });
    }

    // Add these sound effects right after your script tag starts
    const sounds = {
        eat: new Audio('sounds/eat.mp3'),
        die: new Audio('sounds/die.mp3'),
        levelComplete: new Audio('sounds/level-complete.mp3'),
        gameComplete: new Audio('sounds/game-complete.mp3')
    };

    // Add event listener for gender selection
    document.getElementById('playerGender').addEventListener('change', function() {
        if (this.value === 'tiktoker') {
            const gaySound = new Audio('gay.mp3');
            gaySound.play().catch(err => console.log('Sound play failed:', err));
            alert("Congratulations! You've chosen to be a TikToker! 🎵");
        }
    });
  </script>
</body>
</html>